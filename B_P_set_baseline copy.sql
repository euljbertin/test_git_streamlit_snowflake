use database CH_PRD_DB;
use schema DWH_WRK;

use warehouse WH_PROMO;

--read margin files 
execute task BASELINEPREDICTION_LOAD_MARGIN_FILES;

--execute data with current coop data
execute task baselineprediction_data_prep;


call BASELINEPREDICTION_DATAPREP_BEFORE_INTERPOLATION();


select get_ddl('TABLE', 'CH_DEV_DB.DWH_WRK.BASELINEPREDICTION_COOP_AGG_PROMO_INTERPOLATE_0SERIES');

use warehouse WH_ML;
show procedures;
show tasks;

select * from BASELINEPREDICTION_BASELINE_PREDICTION order by dday desc limit 10 ;


--predict baseline every sunday since Nov 1st 2024 (we predict only 12 weeks as it will the result is updates during each run)
--nov 24
call BASELINEPREDICTION_BASELINE_PREDICTION('2024-11-03 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2024-11-10 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2024-11-17 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2024-11-24 00:00:00', 10, 1);
--dec 24
call BASELINEPREDICTION_BASELINE_PREDICTION('2024-12-01 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2024-12-08 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2024-12-15 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2024-12-22 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2024-12-29 00:00:00', 10, 1);
--jan 25
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-01-05 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-01-12 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-01-19 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-01-26 00:00:00', 10, 1);
--fev 25
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-02-02 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-02-09 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-02-16 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-02-23 00:00:00', 10, 1);
--mar 25
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-03-02 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-03-09 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-03-16 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-03-23 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-03-30 00:00:00', 10, 1);

--avril 25
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-04-06 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-04-13 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-04-20 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-04-27 00:00:00', 10, 1);

--mai 25
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-05-04 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-05-11 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-05-18 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-05-25 00:00:00', 10, 1);

--juin 25
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-06-01 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-06-08 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-06-15 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-06-22 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-06-29 00:00:00', 10, 1);


--juillet 25
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-07-06 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-07-13 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-07-20 00:00:00', 10, 120);




call BASELINEPREDICTION_BASELINE_PREDICTION('2025-03-16 00:00:00', 10, 120);--predict 120 weeks, which a little more than 2 years
--call BASELINEPREDICTION_BASELINE_PREDICTION('2025-03-23 00:00:00', 10, 120);
--call BASELINEPREDICTION_BASELINE_PREDICTION('2025-03-30 00:00:00', 10, 120);






create or replace task BASELINEPREDICTION_create_prediction_baseline
warehouse=WH_ML
as 
BEGIN 
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-06-08 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-06-15 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-06-22 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-06-29 00:00:00', 10, 1);


--juillet 25
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-07-06 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-07-13 00:00:00', 10, 1);
call BASELINEPREDICTION_BASELINE_PREDICTION('2025-07-20 00:00:00', 10, 120);


END;


execute task  BASELINEPREDICTION_create_prediction_baseline;



select * from CH_PRD_DB.DWH_WRK.BASELINEPREDICTION_BASELINE_PREDICTION order by dday  limit 10;

select * from BASELINEPREDICTION_BASELINE_PREDICTION order by dday desc limit 10 ;



use warehouse WH_PROMO;

--update KPI table
execute task BASELINEPREDICTION_KPI_UPDATE;


--update increase rates table
execute task BASELINEPREDICTION_IMPACTPROMO_UPDATE_INCREASE_RATES;





-- Pour voir l'historique de TOUTES les tâches
-- pour la base de données et le schéma courants dans les dernières 24 heures
SELECT
    state,
    name AS task_name,
    database_name, -- Information utile pour savoir d'où vient la tâche
    schema_name,   -- Information utile pour savoir d'où vient la tâche
    scheduled_time,
    completed_time,
    error_code,
    error_message,
    query_id,
    datediff(second, scheduled_time, completed_time) as duration_seconds
FROM
    TABLE(INFORMATION_SCHEMA.TASK_HISTORY(
        -- Il est fortement recommandé de toujours mettre une plage de temps
        -- pour ne pas récupérer une quantité massive de données.
        -- Ici, les dernières 24 heures :
        SCHEDULED_TIME_RANGE_START => DATEADD('hour', -24, CURRENT_TIMESTAMP())
    ))
    where database_name = 'CH_PRD_DB'
ORDER BY
    scheduled_time DESC;